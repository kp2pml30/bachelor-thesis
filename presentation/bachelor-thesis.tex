\documentclass[xcolor=table, aspectratio=169]{beamer}

\usepackage{fontspec}
\defaultfontfeatures{Ligatures={TeX},Renderer=Basic}
\setmainfont[Ligatures={TeX,Historic}]{Times New Roman}
\setsansfont{Arial}
\setmonofont{Courier New}

\usepackage[english,russian]{babel}
\usepackage{svg}
\usepackage{pifont}
\usepackage{tikz}
\usepackage{ifthen}
\usepackage{ulem}
\usepackage{listings}

\usepackage{ITMOtheme}

\title[Межъязыковое взаимодействие на платформе Ark]{Поддержка вызова методов и передачи объектов между языками со статическими и динамическими типизациями на платформе Ark}
\ifthenelse{\equal{\presMode}{full}}{
	\author{Прокопенко К.Д.}
	\institute{Open Harmony}
	} {
	\author{Прокопенко К.Д.\\руководитель: Фильченков А.А.\\консультант: Соломенников Д.И.}
	\institute{ITMO}
}
\date{2023}

\newcommand{\cmark}{\ding{51}}
\newcommand{\xmark}{\ding{55}}

\let\SlidesAtEnd\empty

\ifthenelse{\equal{\presMode}{full}}{%
\newcommand{\MoveSlideToEnd}[1]{#1}%
} {%
\newcommand{\MoveSlideToEnd}[1]{
	\let\OldSlidesAtEnd\SlidesAtEnd
	\def\TmpSlidesAtEnd{\OldSlidesAtEnd #1}
	\let\SlidesAtEnd\TmpSlidesAtEnd
}%
}

\makeatletter
\def\rowcolor{{\ifnum0=`}\fi\bmr@rowcolor}
\newcommand<>{\bmr@rowcolor}{%
	\alt#1%
		{\global\let\CT@do@color\CT@@do@color\@ifnextchar[\CT@rowa\CT@rowb}%
		{\ifnum0=`{\fi}\@gooble@rowcolor}%
}
\newcommand{\@gooble@rowcolor}[2][]{\@gooble@rowcolor@}
	\newcommand{\@gooble@rowcolor@}[1][]{\@gooble@rowcolor@@}
	\newcommand{\@gooble@rowcolor@@}[1][]{\ignorespaces}
\makeatother

\setfootlinetext{\insertsection\ifthenelse{\equal{\insertsubsection}{}}{}{/\insertsubsection}}

\lstdefinelanguage{etspseudo}{
	keywords={let, const, typeof, new, true, false, catch, function, return, null, catch, switch, var, if, in, while, do, else, case, break},
	keywordstyle=\color{blue}\bfseries,
	ndkeywords={class, export, boolean, throw, implements, import, this, void, int, long, short, double},
	ndkeywordstyle=\color{purple}\bfseries,
	identifierstyle=\color{black},
	sensitive=false,
	comment=[l]{//},
	morecomment=[s]{/*}{*/},
	commentstyle=\color{purple}\ttfamily,
	stringstyle=\color{red}\ttfamily,
	morestring=[b]',
	morestring=[b]"
}

\lstset{
	showtabs=true,
	breaklines=true,
	language=etspseudo,
}

\makeatletter
\patchcmd{\beamer@sectionintoc}
	{\vfill}
	{\vskip-\itemsep}
	{}
	{}
\makeatother

\begin{document}

\tikzstyle{every picture}+=[remember picture]
\tikzstyle{na}=[shape=rectangle,inner sep=0pt,text depth=0pt]

\AtBeginSection[]
{
	\begin{frame}[plain, noframenumbering]
		\frametitle{Outline}
		%\Large
		\small
		\tableofcontents[currentsection, hideallsubsections]
	\end{frame}
}

\AtBeginSubsection[]
{
	\begin{frame}[plain, noframenumbering]
		\frametitle{Outline}
		\small
		\tableofcontents[currentsection, currentsubsection, subsectionstyle=show/shaded/hide]
	\end{frame}
}

\begin{frame}[plain]
	\titlepage
\end{frame}

\begin{frame}
\frametitle{Цели работы}
\begin{itemize}
	\item Исследование существующих решений в области межъязыкового взаимодействия
	\item Выделение затрагиваемых компонент платформы
	\item Реализация прототипа
	\item Оценка результатов
\end{itemize}
\end{frame}

\section{Обзор}

\begin{frame}
\frametitle{Актуальность}
\begin{itemize}
	\item Переиспользование кода
	\item Гибкость решений
	\item Кооперация
	\item Упрощение найма сотрудников
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{Существующие решения}
\begin{itemize}
	\item Нативный-нативный
		\begin{itemize}
			\item{C++, Zig, Carbon}
		\end{itemize}
	\pause
	\item Управляемый-нативный
		\begin{itemize}
			\item{FFI (Haskell, python, \dots)}
			\item{JNI, Project Panama}
			\item{LuaJIT}
			\item{CPPYY}
		\end{itemize}
	\pause
	\item Управляемый-управляемый
		\begin{itemize}
			\item{JVM/.NET}
			\begin{itemize}
				\item{Kotlin, Scala}
				\item{Nashorn}
				\item{Graal VM}
			\end{itemize}
		\end{itemize}
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{Особенности платформы Ark}
Наличие нескольких виртуальных машин влечет следующее:
\begin{enumerate}
	\item Различные среды исполнения
	\item Различные наборы инструкций
	\item Различное представление данных
\end{enumerate}
Однако, компоненты имеют обобщенные фрагменты
\end{frame}

\section{Представление объектов}

\subsection{NaN упаковка}

\begin{frame}
\frametitle{Общая идея}
Представление число с плавающей точкой двойной точности
\begin{center}
\begin{tabular}{|c|c|c|c|c|c|}
\hline
число бит & 1 & 11 & \multicolumn{3}{c|}{52} \\
\hline
значение & знак & экспонента & \multicolumn{3}{c|}{мантисса} \\
\hline
NaN & знак & 1\dots 1 & \multicolumn{3}{c|}{мантисса} \\
\hline
qNaN indefinite & знак & 1\dots 1 & 1 & \multicolumn{2}{c|}{0\dots0} \\
\hline
кодирование & знак & 1\dots 1 & 1 & тэг & значение \\
\hline
\end{tabular}
\end{center}
\end{frame}

\begin{frame}
\frametitle{Реализация в Ark}
\begin{center}
\begin{tabular}{|c|c|c|}
\hline
число бит & 16 & 48 \\
\hline
значение & ``тэг'' & нагрузка \\
\hline
object & \texttt{0000} & указатель \\
\hline
float64 & \begin{tabular}{c} \texttt{0001} \\ --- \\ \texttt{fffe} \end{tabular} & \dots \\
\hline
int32 & \texttt{ffff} & int32 \\
\hline
\end{tabular}
\end{center}
\end{frame}

\begin{frame}
\frametitle{Расширение в Ark}
\begin{center}
\begin{tabular}{|c|c|c|c|}
\hline
число бит & 16 & \multicolumn{2}{c|}{48} \\
\hline
значение & \multicolumn{2}{c}{``тэг''} & нагрузка \\
\hline
object & \texttt{0000} & \texttt{0} & указатель \\
\hline
foreign object & \texttt{0000} & \texttt{1} & указатель \\
\hline
float64 & \begin{tabular}{c} \texttt{0001} \\ ---- \\ \texttt{fffe} \end{tabular} & \multicolumn{2}{c|}{\dots} \\
\hline
int32 & \texttt{ffff} & \multicolumn{2}{c|}{int32} \\
\hline
\end{tabular}
\end{center}
\end{frame}

\subsection{На динамически типизированной стороне}

\begin{frame}
\frametitle{Представление объектов на динамически типизирвоанной стороне}
\begin{itemize}
	\item[] Как представить ``инородный'' объект?
	\pause
	\begin{itemize}
		\item[] Новым тегом
	\end{itemize}
	\pause
	\item[] Как представить статические поля и методы?
	\pause
	\begin{itemize}
		\item[] Полиморфизмом по типу объекта
	\end{itemize}
\end{itemize}
\end{frame}

\subsection{На статически типизированной стороне}

\begin{frame}
	\frametitle{Новая иерархия классов}
	\begin{center}
		\includesvg{build/res/dot/statically-typed-tree.dot}
	\end{center}
\end{frame}

\ifthenelse{\equal{\presMode}{full}}{
	\section{``Присваивающее действие''}
} {
}

\section{Управление потоками}

\begin{frame}
\frametitle{Состояние потока}
\begin{itemize}
	\item Инкапсулирует данные необходимые для исполнения языка
	\item Хранится в переменной локльной для потока или в регистре
	\item Должно быть консистентно\pause, что означает, что:
	\begin{itemize}
		\item необходимо подменять при вызове функций из другого языка
		\item необходимо возвращать при обработке исключений
		\item необходимо переключать в мостах
		\item не должны появляться гонки данных
	\end{itemize}
\end{itemize}
\ifthenelse{\equal{\presMode}{full}}{\pause{\color{red} Необходимо обмануть \texttt{MutatorLock}}} {}
\end{frame}


\section{Вызов методов}

\begin{frame}
\frametitle{На статически типизированной стороне}
\begin{itemize}
	\item[\xmark] Встраиваемые кэши
	\item[\cmark] ``MethodHandle''
\end{itemize}
\end{frame}

\subsection{На динамически типизированной стороне}

\subsection{Перегрузка}
\begin{frame}
\frametitle{Виды перегрузки}
\begin{itemize}
	\item \only<1>{по аттрибутам \texttt{this}}\only<2->{\sout{по аттрибутам \texttt{this}}}
	\pause
	\item по числу аргументов (elixir, erlang)
	\item по типам аргументов (typescript?)
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{Перегрузка методов в GraalVM}
	Что вызовет \texttt{foo(1)}?\\
	\begin{enumerate}
		\item \lstinline|foo(arg: double): void|
		\item \lstinline|foo(arg: int): void|
		\item \lstinline|foo(arg: short): void|
	\end{enumerate}
	\pause
	Ответ:
	\begin{itemize}
		\item Из статически типизированного языка --- 2
		\item Из динамически типизированного языка --- 3
	\end{itemize}
\end{frame}

\begin{frame}
\frametitle{Решение}
\begin{itemize}
	\item Наличие перегрузки по числу аргументов
	\item Выбор набора наиболее общих сигнатур
	\begin{itemize}
		\item Главенство вызывающего языка
		\item Производительность
	\end{itemize}
\end{itemize}
\end{frame}

\subsection{Пример}

\begin{frame}[fragile]
\frametitle{Данные}

\begin{center}
\begin{tabular}{|l|l|}
\hline
Статический & Динамический \\
\hline
\begin{lstlisting}
class Klass {
  func(a: int): void
  func(): void
}
\end{lstlisting} &
\begin{lstlisting}
let ins /* : Klass */
let arg /* : number */
\end{lstlisting} \\
\hline
\multicolumn{2}{|c|}{\lstinline|ins.func(arg)|}\\
\hline
\begin{lstlisting}
Klass.func.virtual(
  ins,
  arg
)
\end{lstlisting} & \only<2>{\cellcolor{lime}}\begin{lstlisting}
ins['func'](
  this=ins,
  args=(arg,)
)
\end{lstlisting} \\
\hline
\end{tabular}
\end{center}

%\begin{itemize}
%	\item[] \tikz\node[na](V1){ins};.\tikz\node[na](F1){func};(\tikz\node[na](A1){arg};)
%	\item[]
%	\item[] (\tikz\node[na](V3){ins};[\tikz\node[na](F2){`func'};])(this=\tikz\node[na](V2){ins};, args=[\tikz\node[na](A2){arg};])
%\end{itemize}
%\begin{tikzpicture}[remember picture,overlay,cyan,rounded corners,>=stealth,shorten > =1pt,shorten <=1pt,thick]
%	\draw[->] (A1.south) -- (A2.north);
%	\draw[->] (F1.south) -- (F2.north);
%	\draw[->] (V1.south) -- (V2.north);
%	\draw[->] (V1.south) -- (V3.north);
%\end{tikzpicture}

\end{frame}

\begin{frame}
\frametitle{Промежуточное представление}
\begin{center}
\begin{tabular}{|c|c|c|c|}
\hline
№ & инструкция & ввод & пользователи \\
\hline
0 & Register Ins & & 2 \\
1 & Register Arg & & 0 \\
\rowcolor<1->{lime}2 & LoadByName ``func'' & 0 & 3 \\
\rowcolor<1->{lightgray}3 & CallDynThis & 2, 0, 1 &\\
\hline
\end{tabular}
\end{center}
\end{frame}

\begin{frame}
\frametitle{Оптимизация}
\begin{center}
\begin{tabular}{|c|c|c|r|}
\hline
№ & инструкция & ввод & пользователи \\
\hline
0 & Register Ins & & 2, 5 \\
1 & Register Arg & & 0 \\
\rowcolor{lime}\tikz\node[na](DEOPTKLASS){2}; & DeoptimizeIfNotInstance "Klass" & 0 & \only<3>{7} \\
\rowcolor<3>{red}\rowcolor<-2>{lime}\tikz\node[na](CONST){3}; & Constant "func\_const" & & 4\\
\rowcolor<3>{red}\rowcolor<-2>{lightgray}\tikz\node[na](DEOPT){4}; & DeoptimizeIfNE "func\_const" & 3 &\\
\rowcolor<3>{red}\rowcolor<-2>{lightgray}\tikz\node[na](DEOPTKLASS2){5}; & DeoptimizeIfNotInstance "Klass" & 0 & \only<-2>{7} \\
\rowcolor{lightgray}6 & DeoptimizeIfNotNumber & 1 & 7 \\
\rowcolor{lightgray}7 & CallVirtual "Klass.func/1" & \only<-2>{5}\only<3>{2}, 6 &\\
\hline
\end{tabular}
\end{center}
\only<2>{
\begin{tikzpicture}[remember picture,overlay,cyan,rounded corners,>=stealth,shorten > =1pt,shorten <=1pt,thick]
	\draw[->, color=black] (CONST.west) to [bend right=45] (DEOPT.west);
	\draw[->, color=black] (DEOPTKLASS.west) to [bend right=60] (DEOPTKLASS2.west);
\end{tikzpicture}
}
\end{frame}

\section{Управление памятью}

\begin{frame}
\frametitle{Элементы управления памятью}
\begin{enumerate}
	\item Аллокация объектов
	\item Обход стеков
	\begin{enumerate}
		\item определение типа метода
		\item выбор стеков из состояний потока
	\end{enumerate}
	\item Маркировка объектов
	\ifthenelse{\equal{\presMode}{full}}{\item проблемы с выбором {\color{red}ReferenceProcessor}'а}{}
\end{enumerate}
\end{frame}

\MoveSlideToEnd{
\begin{frame}
\frametitle{Иерархия маркеров --- старая}
\begin{center}
\includesvg{build/res/dot/marker_was.dot}
\end{center}
\end{frame}
\begin{frame}
\frametitle{Иерархия маркеров --- новая}
\begin{center}
\scalebox{0.6}{
\includesvg{build/res/dot/marker_new.dot}
}
\end{center}
\end{frame}
}

\section{Замеры производительности}

\begin{frame}[plain]
\itmopolygons{
	\vfill
	\Huge{Спасибо за внимание}
	\only<2>{\\ Вопросы?}
	\vfill
	%\includegraphics[scale=.5]{itmo/slogan.pdf}
}
\end{frame}

\SlidesAtEnd

\end{document}
